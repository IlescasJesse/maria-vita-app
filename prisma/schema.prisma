// Esquema de Base de Datos Prisma para Maria Vita
// Este archivo define la estructura de datos en MySQL

// Configuración del generador y fuente de datos
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// MÓDULO DE USUARIOS Y AUTENTICACIÓN
// ============================================

/// Tabla de usuarios del sistema
/// Almacena credenciales y datos básicos
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(PATIENT)
  firstName    String   @map("first_name") @db.VarChar(100)
  lastName     String   @map("last_name") @db.VarChar(100)
  phone        String?  @db.VarChar(15)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  specialist        Specialist?
  appointmentsAsPatient Appointment[] @relation("PatientAppointments")
  studyRequests     StudyRequest[]

  @@map("users")
}

/// Enum de roles de usuario
enum UserRole {
  ADMIN
  SPECIALIST
  PATIENT
  RECEPTIONIST
}

// ============================================
// MÓDULO DE ESPECIALISTAS
// ============================================

/// Tabla de especialistas médicos
/// Extiende la información del usuario cuando es médico
model Specialist {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  fullName          String   @map("full_name") @db.VarChar(200)
  specialty         String   @db.VarChar(100)
  licenseNumber     String   @unique @map("license_number") @db.VarChar(20)
  assignedOffice    String?  @map("assigned_office") @db.VarChar(50)
  biography         String?  @db.Text
  yearsOfExperience Int?     @map("years_of_experience")
  photoUrl          String?  @map("photo_url") @db.VarChar(500)
  consultationFee   Decimal? @map("consultation_fee") @db.Decimal(10, 2)
  isAvailable       Boolean  @default(true) @map("is_available")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relaciones
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  availability  Availability[]
  appointments  Appointment[]

  @@map("specialists")
  @@index([specialty])
  @@index([isAvailable])
}

// ============================================
// MÓDULO DE AGENDA Y DISPONIBILIDAD
// ============================================

/// Tabla de disponibilidad recurrente de especialistas
/// Define los horarios base semana a semana
model Availability {
  id            String    @id @default(uuid())
  specialistId  String    @map("specialist_id")
  dayOfWeek     DayOfWeek @map("day_of_week")
  startTime     String    @map("start_time") @db.VarChar(5) // Formato HH:mm
  endTime       String    @map("end_time") @db.VarChar(5)   // Formato HH:mm
  slotDuration  Int       @map("slot_duration") // Minutos por cita
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relaciones
  specialist Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@map("availability")
  @@index([specialistId, dayOfWeek])
}

/// Enum de días de la semana
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

/// Tabla de citas médicas agendadas
/// Registra cada cita individual con paciente y especialista
model Appointment {
  id              String            @id @default(uuid())
  patientId       String            @map("patient_id")
  specialistId    String            @map("specialist_id")
  scheduledDate   DateTime          @map("scheduled_date")
  durationMinutes Int               @map("duration_minutes")
  status          AppointmentStatus @default(PENDING)
  reason          String?           @db.Text
  notes           String?           @db.Text
  cancelReason    String?           @map("cancel_reason") @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relaciones
  patient    User       @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  specialist Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@map("appointments")
  @@index([patientId])
  @@index([specialistId])
  @@index([scheduledDate])
  @@index([status])
}

/// Enum de estados de cita
enum AppointmentStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================
// MÓDULO DE ESTUDIOS Y LABORATORIO
// ============================================

/// Catálogo de estudios médicos disponibles
/// Define los tipos de análisis que se pueden solicitar
model StudyCatalog {
  id                      String   @id @default(uuid())
  name                    String   @db.VarChar(200)
  description             String?  @db.Text
  category                String   @db.VarChar(100)
  price                   Decimal  @db.Decimal(10, 2)
  preparationInstructions String?  @map("preparation_instructions") @db.Text
  estimatedDuration       Int?     @map("estimated_duration") // Horas
  requiresFasting         Boolean  @default(false) @map("requires_fasting")
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("study_catalog")
  @@index([category])
  @@index([isActive])
}

/// Tabla de solicitudes de estudios
/// Registra las órdenes de laboratorio antes de tener resultados
model StudyRequest {
  id                 String             @id @default(uuid())
  patientId          String             @map("patient_id")
  referringDoctorId  String?            @map("referring_doctor_id")
  studies            Json               // Array de {studyId, studyName, price, quantity}
  totalAmount        Decimal            @map("total_amount") @db.Decimal(10, 2)
  status             StudyRequestStatus @default(DRAFT)
  paymentMethod      String?            @map("payment_method") @db.VarChar(50)
  paymentDate        DateTime?          @map("payment_date")
  scheduledDate      DateTime?          @map("scheduled_date")
  notes              String?            @db.Text
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relaciones
  patient User @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("study_requests")
  @@index([patientId])
  @@index([status])
  @@index([scheduledDate])
}

/// Enum de estados de solicitud de estudio
enum StudyRequestStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
